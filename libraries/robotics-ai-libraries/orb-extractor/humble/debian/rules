#!/usr/bin/make -f

include /usr/share/dpkg/pkg-info.mk
include /usr/share/dpkg/vendor.mk

# Uncomment this to turn on verbose mode.
export DH_VERBOSE=1


# special characters
empty :=
space := $(empty) $(empty)
comma := ,
semicol := ;

# helper to create comma separated list from space separated list
commasep = $(subst $(space),$(comma)$(space),$1)
semicolsep = $(subst $(space),$(comma),$1)

# remove double quotes
unquote = $(subst $\",,$1)

# recursive wildcard
rwildcard=$(foreach d,$(wildcard $(1:=/*)),$(call rwildcard,$d,$2) $(filter $(subst *,%,$2),$d))

# Hardening.
export DEB_BUILD_MAINT_OPTIONS=hardening=+all
export DEB_CXXFLAGS_MAINT_APPEND = -g1
export DEB_HOST_MULTIARCH := $(shell dpkg-architecture -qDEB_HOST_MULTIARCH)

CFLAGS := $(filter-out "-flto=auto -ffat-lto-objects -flto=auto -ffat-lto-objects", $(shell dpkg-buildflags --get CFLAGS))
CXXFLAGS := $(filter-out "-flto=auto -ffat-lto-objects -flto=auto -ffat-lto-objects", $(shell dpkg-buildflags --get CXXFLAGS))
LDFLAGS  := $(filter-out "-flto=auto -ffat-lto-objects -flto=auto", $(shell dpkg-buildflags --get LDFLAGS))

optdir := opt/intel/orb_lze

BUILD_LIBORB_DIR=$(CURDIR)/build
BUILD_ORBTEST_DIR=$(CURDIR)/build-orbtest

export DEB_CXXFLAGS_MAINT_APPEND +=-DNDEBUG

override_dh_auto_configure:
	if [ -f "/opt/intel/oneapi/setvars.sh" ]; then . "/opt/intel/oneapi/setvars.sh"; fi && \
	dh_auto_configure -O--buildsystem=cmake 	\
		-O--builddir=$(BUILD_LIBORB_DIR) 	\
		--sourcedirectory=$(CURDIR)/ --   	\
		-DCMAKE_BUILD_TYPE=Release              \
		-DCMAKE_INSTALL_INCLUDEDIR=include/

	# Configure tests
	if [ -f "/opt/intel/oneapi/setvars.sh" ]; then . "/opt/intel/oneapi/setvars.sh"; fi && \
	cd $(CURDIR)/tests && mkdir -p "$(CURDIR)/build-orbtest" && cd "$(CURDIR)/build-orbtest" && cmake $(CURDIR)/tests \
		-DCMAKE_BUILD_TYPE=Release

override_dh_auto_build:
	if [ -f "/opt/intel/oneapi/setvars.sh" ]; then . "/opt/intel/oneapi/setvars.sh"; fi && \
	dh_auto_build -O--buildsystem=cmake 		\
		-O--builddir=$(BUILD_LIBORB_DIR) 	\
		--sourcedirectory=$(CURDIR)/ --

	# Build tests
	if [ -f "/opt/intel/oneapi/setvars.sh" ]; then . "/opt/intel/oneapi/setvars.sh"; fi && \
	cd $(CURDIR)/build-orbtest && $(MAKE)

override_dh_shlibdeps:
	if [ -f "/opt/intel/oneapi/setvars.sh" ]; then . "/opt/intel/oneapi/setvars.sh"; fi && \
	dh_shlibdeps

override_dh_auto_clean:
	$(RM) -r $(CURDIR)/build $(CURDIR)/build-orbtest && 			\
	dh_clean

override_dh_auto_install:
	if [ -f "/opt/intel/oneapi/setvars.sh" ]; then . "/opt/intel/oneapi/setvars.sh"; fi && \
	dh_auto_install -O--buildsystem=cmake 		\
		-O--builddir=$(BUILD_LIBORB_DIR) 	\
		--sourcedirectory=$(CURDIR)/ --
	install -d $(CURDIR)/debian/tmp/$(optdir)/samples
	install -m 0644 $(CURDIR)/samples/* \
		$(CURDIR)/debian/tmp/$(optdir)/samples
	install -m 0644 $(CURDIR)/images/* \
		$(CURDIR)/debian/tmp/$(optdir)/samples
	install -d $(CURDIR)/debian/tmp/$(optdir)/tests
	cd $(CURDIR)/build-orbtest && find . -maxdepth 1 -type f -executable -exec install -m 0755 {} $(CURDIR)/debian/tmp/$(optdir)/tests/ \;
	# Copy fuzzer sources for container-aware builds
	if [ -d $(CURDIR)/tests/fuzzer ]; then \
		install -m 0644 $(CURDIR)/tests/fuzzer/simple_fuzzer_*.cpp $(CURDIR)/debian/tmp/$(optdir)/tests/ 2>/dev/null || true; \
	fi
	# Copy test images to tests directory
	install -m 0644 $(CURDIR)/images/* \
		$(CURDIR)/debian/tmp/$(optdir)/tests/
%:
	dh $@ -v $(PARALLEL)
